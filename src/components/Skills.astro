---
/**
 * Skills Section — MUI brandingTheme.ts
 * Interactive categorized tech stack with animated progress indicators.
 */

interface Skill {
  name: string;
  level: number; // 0-100
  tag: string; // Avanzado, Intermedio, etc.
  devicon?: string; // Devicon icon slug (e.g., "react", "angular")
  customIcon?: string; // Inline SVG for concepts without brand icons
}

interface SkillCategory {
  id: string;
  label: string;
  i18nKey: string;
  icon: string;
  color: string;
  skills: Skill[];
}

/** Custom SVG icons for concepts without brand icons (use currentColor for theme adaptation) */
const customSkillIcons: Record<string, string> = {
  solid: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M9 12l2 2 4-4"/></svg>',
  cleanarch: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6.5"/><circle cx="12" cy="12" r="3"/></svg>',
  mvvm: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="1.5" width="18" height="4.5" rx="1.5"/><rect x="3" y="9.75" width="18" height="4.5" rx="1.5"/><rect x="3" y="18" width="18" height="4.5" rx="1.5"/><path d="M12 6v3.75M12 14.25v3.75"/></svg>',
  rup: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 12a9.5 9.5 0 11-7-9"/><path d="M21.5 3v5h-5"/></svg>',
  rhapsody: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="2" width="7" height="5" rx="1"/><rect x="14" y="2" width="7" height="5" rx="1"/><rect x="8.5" y="17" width="7" height="5" rx="1"/><path d="M6.5 7v4.5h11V7"/><path d="M12 11.5v5.5"/></svg>',
};

const categories: SkillCategory[] = [
  {
    id: "mobile",
    label: "Mobile",
    i18nKey: "skills.cat_mobile",
    icon: "mobile",
    color: "brand",
    skills: [
      { name: ".NET MAUI", level: 95, tag: "Advanced", devicon: "dotnetcore" },
      { name: "Xamarin.Forms", level: 90, tag: "Advanced", devicon: "xamarin" },
      { name: "Android Nativo (Kotlin/XML)", level: 60, tag: "Intermediate", devicon: "kotlin" },
    ],
  },
  {
    id: "backend",
    label: "Backend",
    i18nKey: "skills.cat_backend",
    icon: "backend",
    color: "violet",
    skills: [
      { name: "ASP.NET Core Web API", level: 85, tag: "Advanced", devicon: "dotnetcore" },
      { name: "Java Spring Boot", level: 55, tag: "Basic-Intermediate", devicon: "spring" },
    ],
  },
  {
    id: "frontend",
    label: "Frontend",
    i18nKey: "skills.cat_frontend",
    icon: "frontend",
    color: "accent",
    skills: [
      { name: "Angular", level: 55, tag: "Basic-Intermediate", devicon: "angular" },
      { name: "React", level: 55, tag: "Basic-Intermediate", devicon: "react" },
      { name: "ASP.NET Core MVC (Razor)", level: 70, tag: "Intermediate", devicon: "dotnetcore" },
    ],
  },
  {
    id: "databases",
    label: "Databases",
    i18nKey: "skills.cat_databases",
    icon: "databases",
    color: "brand",
    skills: [
      { name: "SQL Server", level: 80, tag: "Advanced", devicon: "microsoftsqlserver" },
      { name: "MySQL", level: 75, tag: "Intermediate", devicon: "mysql" },
      { name: "MongoDB", level: 60, tag: "Intermediate", devicon: "mongodb" },
      { name: "SQLite", level: 70, tag: "Intermediate", devicon: "sqlite" },
    ],
  },
  {
    id: "architecture",
    label: "Engineering / Arch.",
    i18nKey: "skills.cat_architecture",
    icon: "architecture",
    color: "violet",
    skills: [
      { name: "SOLID Principles", level: 85, tag: "Advanced", customIcon: customSkillIcons.solid },
      { name: "Clean Architecture", level: 85, tag: "Advanced", customIcon: customSkillIcons.cleanarch },
      { name: "MVVM", level: 90, tag: "Advanced", customIcon: customSkillIcons.mvvm },
      { name: "RUP Methodology", level: 70, tag: "Intermediate", customIcon: customSkillIcons.rup },
    ],
  },
  {
    id: "cloud",
    label: "Cloud / DevOps",
    i18nKey: "skills.cat_cloud",
    icon: "cloud",
    color: "accent",
    skills: [
      { name: "Microsoft Azure", level: 65, tag: "Intermediate", devicon: "azure" },
      { name: "GitHub Actions", level: 75, tag: "Intermediate", devicon: "githubactions" },
      { name: "Git", level: 85, tag: "Advanced", devicon: "git" },
    ],
  },
  {
    id: "tools",
    label: "Tools",
    i18nKey: "skills.cat_tools",
    icon: "tools",
    color: "brand",
    skills: [
      { name: "Figma", level: 70, tag: "Intermediate", devicon: "figma" },
      { name: "IBM Rhapsody", level: 65, tag: "Intermediate", customIcon: customSkillIcons.rhapsody },
    ],
  },
];

function getBarColor(color: string): string {
  const colors: Record<string, string> = {
    brand: "from-primary-500 to-primary-300",
    violet: "from-primary-600 to-primary-400",
    accent: "from-primary-400 to-primary-200",
  };
  return colors[color] || colors.brand;
}

function getTagColor(tag: string): string {
  if (tag.includes("Advanced") || tag.includes("Avanzado")) return "text-emerald-400 bg-emerald-400/10";
  if (tag.includes("Intermediate") || tag.includes("Intermedio")) return "text-amber-400 bg-amber-400/10";
  return "text-white/50 bg-white/5";
}

/** Devicon CDN URL builder */
function getDeviconUrl(slug: string): string {
  const exceptions: Record<string, string> = {
    microsoftsqlserver: "plain",
  };
  const variant = exceptions[slug] || "original";
  return `https://cdn.jsdelivr.net/gh/devicons/devicon@latest/icons/${slug}/${slug}-${variant}.svg`;
}

const iconSvgs: Record<string, string> = {
  mobile: '<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="5" y="1" width="14" height="22" rx="2.5"/><path d="M10 19h4"/><circle cx="12" cy="5" r="0.5" fill="currentColor"/></svg>',
  backend: '<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="20" height="7" rx="1.5"/><rect x="2" y="14" width="20" height="7" rx="1.5"/><circle cx="6" cy="6.5" r="1" fill="currentColor"/><circle cx="6" cy="17.5" r="1" fill="currentColor"/><line x1="10" y1="6.5" x2="18" y2="6.5"/><line x1="10" y1="17.5" x2="18" y2="17.5"/></svg>',
  frontend: '<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M2 7h20"/><path d="M8 21h8"/><path d="M12 17v4"/><circle cx="5" cy="5" r="0.5" fill="currentColor"/><circle cx="7.5" cy="5" r="0.5" fill="currentColor"/><circle cx="10" cy="5" r="0.5" fill="currentColor"/></svg>',
  databases: '<svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>',
  architecture: '<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>',
  cloud: '<svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M18 10h-1.26A8 8 0 109 20h9a5 5 0 000-10z"/></svg>',
  tools: '<svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>',
};
---

<section id="skills" class="relative py-24 lg:py-32">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Section Header -->
    <div class="text-center mb-16 reveal-up">
      <p class="mui-overline" data-i18n="skills.overline">Technical Skills</p>
      <h2 class="mui-h2" data-i18n-html="skills.titleHtml">
        My <span class="gradient-text">tech arsenal</span>
      </h2>
      <p class="mt-4 max-w-2xl mx-auto text-sm sm:text-base" style="color: var(--mui-text-muted);" data-i18n="skills.description">
        Tools and technologies I master to build end-to-end solutions,
        from mobile apps to robust backend architectures.
      </p>
    </div>

    <!-- Category Tabs -->
    <div class="flex flex-wrap justify-center gap-2 mb-12 reveal-up" id="skill-tabs" role="tablist" aria-label="Skill categories" data-i18n-aria="skills.tabsAria">
      {categories.map((cat, i) => (
        <button
          data-tab={cat.id}
          role="tab"
          aria-selected={i === 0 ? "true" : "false"}
          aria-controls={`panel-${cat.id}`}
          id={`tab-${cat.id}`}
          tabindex={i === 0 ? "0" : "-1"}
          class:list={[
            "skill-tab inline-flex items-center gap-1.5 px-4 py-2 rounded-xl text-xs sm:text-sm font-medium cursor-pointer",
            "border",
            i === 0
              ? "skill-tab-active"
              : "border-transparent",
          ]}
          style="transition: border-color 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;"
        >
          <span class="shrink-0 inline-flex" aria-hidden="true" set:html={iconSvgs[cat.icon]} />
          <span data-i18n={cat.i18nKey}>{cat.label}</span>
        </button>
      ))}
    </div>

    <!-- Skills Content -->
    <div id="skills-content" class="max-w-3xl mx-auto">
      {categories.map((cat, catIndex) => (
        <div
          data-panel={cat.id}
          id={`panel-${cat.id}`}
          role="tabpanel"
          aria-labelledby={`tab-${cat.id}`}
          tabindex="0"
          class:list={["skill-panel space-y-5", catIndex !== 0 && "hidden"]}
        >
          {cat.skills.map((skill) => (
            <div class="group">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-3">
                  {skill.devicon && (
                    <span class="skill-icon-badge">
                      <img
                        src={getDeviconUrl(skill.devicon)}
                        alt=""
                        loading="lazy"
                        decoding="async"
                      />
                    </span>
                  )}
                  {skill.customIcon && !skill.devicon && (
                    <span class="skill-icon-badge skill-icon-custom" set:html={skill.customIcon} />
                  )}
                  <span class="text-sm font-medium transition-colors" style="color: var(--mui-text-secondary);">
                    {skill.name}
                  </span>
                  <span
                    class:list={[
                      "px-2 py-0.5 rounded-md text-[10px] font-semibold",
                      getTagColor(skill.tag),
                    ]}
                  >
                    {skill.tag}
                  </span>
                </div>
                <span class="text-xs font-mono" style="color: var(--mui-text-disabled);">{skill.level}%</span>
              </div>
              <div class="h-2 rounded-full overflow-hidden" style="background: var(--mui-primary-bg);">
                <div
                  class:list={[
                    "skill-bar-fill h-full rounded-full bg-linear-to-r",
                    getBarColor(cat.color),
                  ]}
                  data-width={`${skill.level}%`}
                  style="width: 0%;"
                  role="progressbar"
                  aria-valuenow={skill.level}
                  aria-valuemin={0}
                  aria-valuemax={100}
                  aria-label={`${skill.name}: ${skill.level}%`}
                />
              </div>
            </div>
          ))}
        </div>
      ))}
    </div>

    <!-- Technology Overview -->
    <div class="mt-20" id="tech-overview">
      <!-- Main Stack — Featured -->
      <div class="mb-6 reveal-up">
        <div class="flex items-center gap-3 mb-5">
          <div class="h-px flex-1" style="background: linear-gradient(90deg, var(--mui-primary), transparent);"></div>
          <p class="text-[10px] sm:text-xs uppercase tracking-[0.3em] font-semibold whitespace-nowrap" style="color: var(--mui-primary);" data-i18n="skills.mainStack">Main Stack</p>
          <div class="h-px flex-1" style="background: linear-gradient(270deg, var(--mui-primary), transparent);"></div>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3" id="main-stack-grid">
          {[
            { name: ".NET MAUI", slug: "dotnetcore", role: "Mobile", color: "hsl(267, 56%, 53%)" },
            { name: "ASP.NET Core", slug: "dotnetcore", role: "Backend", color: "hsl(210, 100%, 45%)" },
            { name: "ASP.NET MVC", slug: "dotnetcore", role: "Frontend", color: "hsl(150, 60%, 40%)" },
            { name: "Azure", slug: "azure", role: "Cloud", color: "hsl(199, 91%, 49%)" },
            { name: "SQL Server", slug: "microsoftsqlserver", role: "Database", color: "hsl(355, 82%, 52%)" },
          ].map((tech) => (
            <div
              class="tech-card-primary group"
              style={`--tech-accent: ${tech.color};`}
            >
              <div class="tech-card-primary-glow" aria-hidden="true"></div>
              <div class="relative z-[1] flex flex-col items-center gap-2.5 py-5 px-3">
                <span class="tech-icon-primary">
                  <img
                    src={getDeviconUrl(tech.slug)}
                    alt=""
                    loading="lazy"
                    decoding="async"
                  />
                </span>
                <div class="text-center">
                  <span class="block text-sm font-semibold" style="color: var(--mui-text-primary);">{tech.name}</span>
                  <span class="block text-[10px] uppercase tracking-[0.15em] font-medium mt-0.5" style="color: var(--tech-accent);" data-i18n={`skills.role_${tech.role.toLowerCase()}`}>{tech.role}</span>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>

      <!-- Complementary Technologies -->
      <div class="reveal-up">
        <div class="flex items-center gap-3 mb-5">
          <div class="h-px flex-1" style="background: linear-gradient(90deg, var(--mui-border-subtle), transparent);"></div>
          <p class="text-[10px] sm:text-xs uppercase tracking-[0.3em] font-medium whitespace-nowrap" style="color: var(--mui-text-disabled);" data-i18n="skills.complementary">Complementary</p>
          <div class="h-px flex-1" style="background: linear-gradient(270deg, var(--mui-border-subtle), transparent);"></div>
        </div>
        <div class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-6 gap-2.5" id="complementary-grid">
          {[
            { name: "Xamarin.Forms", slug: "xamarin" },
            { name: "Kotlin", slug: "kotlin" },
            { name: "Angular", slug: "angular" },
            { name: "React", slug: "react" },
            { name: "Spring Boot", slug: "spring" },
            { name: "MySQL", slug: "mysql" },
            { name: "MongoDB", slug: "mongodb" },
            { name: "SQLite", slug: "sqlite" },
            { name: "SOLID", svg: customSkillIcons.solid },
            { name: "Clean Arch.", svg: customSkillIcons.cleanarch },
            { name: "MVVM", svg: customSkillIcons.mvvm },
            { name: "RUP", svg: customSkillIcons.rup },
            { name: "Git", slug: "git" },
            { name: "GitHub Actions", slug: "githubactions" },
            { name: "Figma", slug: "figma" },
            { name: "IBM Rhapsody", svg: customSkillIcons.rhapsody },
          ].map((tech) => (
            <div class="tech-card-secondary group">
              <div class="flex flex-col items-center gap-1.5 py-3 px-2">
                {tech.slug && (
                  <span class="skill-icon-badge">
                    <img
                      src={getDeviconUrl(tech.slug)}
                      alt=""
                      loading="lazy"
                      decoding="async"
                    />
                  </span>
                )}
                {tech.svg && !tech.slug && (
                  <span class="skill-icon-badge skill-icon-custom" set:html={tech.svg} />
                )}
                <span class="text-[10px] sm:text-xs text-center leading-tight" style="color: var(--mui-text-muted);">{tech.name}</span>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  import gsap from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";
  gsap.registerPlugin(ScrollTrigger);

  const tabs = document.querySelectorAll<HTMLElement>(".skill-tab");
  const panels = document.querySelectorAll<HTMLElement>(".skill-panel");
  let initialAnimationDone = false;

  /**
   * Animate skill bars inside a panel.
   * Immediately snaps to 0% (no transition), then GSAP fills to target.
   */
  function animateBarsInPanel(panel: HTMLElement): void {
    const bars = panel.querySelectorAll<HTMLElement>(".skill-bar-fill");

    // Kill any in-flight tweens and snap to 0 instantly
    bars.forEach((bar) => {
      gsap.killTweensOf(bar);
    });
    gsap.set(bars, { width: "0%" });

    // Single staggered tween — natural fill speed (1.2s)
    gsap.to(bars, {
      width: (i, el) => (el as HTMLElement).dataset.width || "0%",
      duration: 1.2,
      ease: "power2.out",
      stagger: 0.1,
      delay: 0.15,
    });
  }

  // ── Tab switching ──
  tabs.forEach((tab) => {
    tab.addEventListener("click", () => {
      const targetId = tab.dataset.tab;

      // Update active tab styling & ARIA
      tabs.forEach((t) => {
        t.classList.remove("skill-tab-active");
        t.classList.add("border-transparent");
        t.setAttribute("aria-selected", "false");
        t.setAttribute("tabindex", "-1");
      });
      tab.classList.remove("border-transparent");
      tab.classList.add("skill-tab-active");
      tab.setAttribute("aria-selected", "true");
      tab.setAttribute("tabindex", "0");

      // Switch panels — hide all, show target, animate only the bars
      panels.forEach((panel) => {
        if (panel.dataset.panel !== targetId) {
          panel.classList.add("hidden");
          // Kill any running animations on hidden panels
          gsap.killTweensOf(panel.children);
          gsap.killTweensOf(panel.querySelectorAll(".skill-bar-fill"));
          gsap.set(panel.children, { clearProps: "all" });
        }
      });

      // Show target panel instantly (no opacity fade — prevents flicker)
      const targetPanel = document.querySelector<HTMLElement>(`[data-panel="${targetId}"]`);
      if (targetPanel) {
        targetPanel.classList.remove("hidden");
        // Ensure children are fully visible
        gsap.set(targetPanel.children, { clearProps: "all" });
        // Fill bars from 0
        animateBarsInPanel(targetPanel);
      }
    });
  });

  // ── Keyboard arrow navigation for tabs (WCAG) ──
  const tabsArray = Array.from(tabs);
  document.getElementById("skill-tabs")?.addEventListener("keydown", (e) => {
    const key = e.key;
    if (!["ArrowLeft", "ArrowRight", "Home", "End"].includes(key)) return;

    e.preventDefault();
    const currentIndex = tabsArray.indexOf(document.activeElement as HTMLElement);
    let nextIndex = currentIndex;

    if (key === "ArrowRight") {
      nextIndex = (currentIndex + 1) % tabsArray.length;
    } else if (key === "ArrowLeft") {
      nextIndex = (currentIndex - 1 + tabsArray.length) % tabsArray.length;
    } else if (key === "Home") {
      nextIndex = 0;
    } else if (key === "End") {
      nextIndex = tabsArray.length - 1;
    }

    tabsArray[nextIndex].focus();
    tabsArray[nextIndex].click();
  });

  // ── Initial scroll-triggered animation (fires once) ──
  ScrollTrigger.create({
    trigger: "#skills-content",
    start: "top 80%",
    once: true,
    onEnter: () => {
      if (initialAnimationDone) return;
      initialAnimationDone = true;
      const visiblePanel = document.querySelector<HTMLElement>(
        ".skill-panel:not(.hidden)"
      );
      if (visiblePanel) {
        animateBarsInPanel(visiblePanel);
      }
    },
  });

  // ── Tech Overview Grid animations ──
  const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;

  if (!prefersReducedMotion) {
    // Main Stack — staggered entrance with scale + glow pulse
    const mainCards = gsap.utils.toArray<HTMLElement>("#main-stack-grid .tech-card-primary");
    gsap.set(mainCards, { opacity: 0, y: 30, scale: 0.92 });

    ScrollTrigger.create({
      trigger: "#tech-overview",
      start: "top 80%",
      once: true,
      onEnter: () => {
        gsap.to(mainCards, {
          opacity: 1,
          y: 0,
          scale: 1,
          duration: 0.7,
          ease: "back.out(1.4)",
          stagger: 0.12,
        });
      },
    });

    // Complementary — faster cascade
    const compCards = gsap.utils.toArray<HTMLElement>("#complementary-grid .tech-card-secondary");
    gsap.set(compCards, { opacity: 0, y: 20 });

    ScrollTrigger.create({
      trigger: "#complementary-grid",
      start: "top 85%",
      once: true,
      onEnter: () => {
        gsap.to(compCards, {
          opacity: 1,
          y: 0,
          duration: 0.5,
          ease: "power2.out",
          stagger: 0.06,
        });
      },
    });
  }
</script>
